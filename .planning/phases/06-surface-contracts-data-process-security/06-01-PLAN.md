---
phase: 06-surface-contracts-data-process-security
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - .planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md
  - .planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md
autonomous: true
requirements: ["SURF-03"]
user_setup: []
must_haves:
  truths:
    - "Persistence contracts capture schema, migration, and transaction/lifecycle behavior for all core project data stores."
    - "Data contract corpus documents deterministic migration and backup behavior needed for regeneration from existing repositories."
  artifacts:
    - ".planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md"
    - ".planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md"
  key_links:
    - "DATA-PERSISTENCE-CONTRACTS.md references DATA-PERSISTENCE-MATRIX.md as canonical 12-unit completeness source."
---

<objective>
Document the complete persistence/data surface as authoritative contracts.

Purpose: Satisfy SURF-03 by specifying schemas, migrations, transaction semantics, and persistence lifecycle rules.
Output: Data/persistence matrix plus detailed data contract specification.
</objective>

<execution_context>
@/Users/peterryszkiewicz/.claude/get-shit-done/workflows/execute-plan.md
@/Users/peterryszkiewicz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/specs/INDEX.md
@.planning/specs/INVENTORY.md
@.planning/specs/contracts/BACKEND-RUNTIME-MATRIX.md
@api/database.py
@api/migration.py
@server/services/assistant_database.py
@server/schemas.py
@server/routers/schedules.py
@server/services/project_config.py
@.planning/phases/06-surface-contracts-data-process-security/06-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Build canonical data/persistence contract matrix</name>
  <files>.planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md</files>
  <action>Create a matrix with exactly 12 contract units (`D01`..`D12`) covering: feature/schedule/override schemas, schema constraints, migration upgrades, JSON->SQLite migration and backup behavior, transaction mode (`BEGIN IMMEDIATE`), journal mode (`WAL` vs `DELETE`) and busy-timeout behavior, assistant conversation persistence, and engine/session lifecycle/disposal semantics. Include columns for unit id, concern, source artifact `ART-####`, persistence objects, invariants/lifecycle rules, and failure/edge behavior.</action>
  <verify>test -f .planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md && test "$(rg -n '^\\| D[0-9]{2} \\|' .planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md | wc -l | tr -d ' ')" = "12"</verify>
  <done>Data/persistence matrix exists with deterministic 12-unit inventory and artifact linkage.</done>
</task>

<task type="auto">
  <name>Task 2: Author persistence/schema/migration contracts</name>
  <files>.planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md</files>
  <action>Author detailed contract sections for schema entities (`features`, `schedules`, `schedule_overrides`, `conversations`, `conversation_messages`), migration lifecycle (`ALTER TABLE` upgrades, JSON import/export, timestamped backup), and runtime transaction semantics (`busy_timeout`, `BEGIN IMMEDIATE`, journal mode selection for network filesystems). Include lifecycle defaults, state invariants, and explicit failure/edge behavior.</action>
  <verify>rg -n "features|schedules|schedule_overrides|conversations|conversation_messages|feature_list.json|BEGIN IMMEDIATE|busy_timeout|journal mode|WAL|DELETE|backup|Acceptance Checks" .planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md</verify>
  <done>Contract doc defines schema, migration, and transaction/lifecycle semantics for all data units.</done>
</task>

<task type="auto">
  <name>Task 3: Add SURF-03 acceptance checks with parity gates</name>
  <files>.planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md</files>
  <action>Add an `Acceptance Checks` section with objective pass/fail criteria proving matrix-to-contract parity (`12/12`), migration behavior coverage, and lifecycle constraint coverage (timeouts, lock semantics, backup handling).</action>
  <verify>rg -n "Acceptance Checks|SURF-03|12/12|matrix-to-contract|migration|lifecycle|pass/fail" .planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md</verify>
  <done>Data contracts contain executable acceptance checks aligned to SURF-03.</done>
</task>

</tasks>

<verification>
Before declaring plan complete:
- [ ] test -f .planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md
- [ ] test -f .planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md
- [ ] test "$(rg -n '^\\| D[0-9]{2} \\|' .planning/specs/surfaces/DATA-PERSISTENCE-MATRIX.md | wc -l | tr -d ' ')" = "12"
- [ ] rg -n "BEGIN IMMEDIATE|journal mode|feature_list.json|Acceptance Checks|12/12" .planning/specs/surfaces/DATA-PERSISTENCE-CONTRACTS.md
- [ ] git diff --name-only | rg -v '^\.planning/' returns no output
</verification>

<success_criteria>

- All tasks completed
- Data contracts capture schemas, migrations, and lifecycle rules for persistence behavior
- Acceptance checks objectively prove SURF-03 parity coverage
- No source implementation files modified

</success_criteria>

<output>
After completion, create `.planning/phases/06-surface-contracts-data-process-security/06-01-SUMMARY.md`
</output>
